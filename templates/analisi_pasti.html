{% extends "layout.html" %}
{% block content %}
<h2 class="text-2xl font-semibold mb-4">Analisi Pasti</h2>

<form method="get" class="mb-6 flex flex-wrap items-center gap-2">
  <label for="start_date">Dal:</label>
  <input type="date" name="start_date" value="{{ start_date }}" required>
  <label for="end_date">Al:</label>
  <input type="date" name="end_date" value="{{ end_date }}" required>
  <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded">Analizza</button>

  <div class="flex flex-wrap gap-2 ml-4">
    <a href="{{ url_for('analisi_pasti', start_date=(oggi - timedelta(days=7)).isoformat(), end_date=oggi.isoformat()) }}"
       class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Ultima Settimana</a>
    <a href="{{ url_for('analisi_pasti', start_date=(oggi - timedelta(days=14)).isoformat(), end_date=oggi.isoformat()) }}"
       class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Ultime 2 Settimane</a>
    <a href="{{ url_for('analisi_pasti', start_date=(oggi - timedelta(days=30)).isoformat(), end_date=oggi.isoformat()) }}"
       class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Mensile</a>
    <a href="{{ url_for('analisi_pasti', start_date='2000-01-01', end_date=oggi.isoformat()) }}"
       class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Totale</a>
  </div>
</form>

{% if date_labels %}
  <canvas id="graficoPasti" height="100"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('graficoPasti').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ date_labels | tojson }},
        datasets: [
          {
            label: 'Proteine (g)',
            data: {{ proteine | tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            stack: 'stack1'
          },
          {
            label: 'Carboidrati (g)',
            data: {{ carboidrati | tojson }},
            backgroundColor: 'rgba(255, 206, 86, 0.6)',
            stack: 'stack1'
          },
          {
            label: 'Grassi (g)',
            data: {{ grassi | tojson }},
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            stack: 'stack1'
          },
          {
            label: 'Calorie (kcal)',
            data: {{ calorie | tojson }},
            type: 'line',
            borderColor: 'rgba(255, 0, 0, 0.9)',
            backgroundColor: 'transparent',
            yAxisID: 'yCalorie'
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: {
            stacked: true,
            title: { display: true, text: 'Macronutrienti (g)' }
          },
          yCalorie: {
            position: 'right',
            title: { display: true, text: 'Calorie (kcal)' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  </script>

  <div class="mt-6 bg-white shadow p-4 rounded">
    <h3 class="text-xl font-semibold mb-2">Commento Nutrizionale</h3>
    <p>{{ commento.replace('\n', '<br>')|safe }}</p>
  </div>
{% endif %}
{% endblock %}
