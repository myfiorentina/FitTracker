{% extends "layout.html" %}
{% block content %}
<h2 class="text-2xl font-semibold mb-4">Analisi Pesature</h2>

<form method="get" class="mb-6 flex flex-wrap items-center gap-2">
  <label for="start_date">Dal:</label>
  <input type="date" name="start_date" value="{{ start_date }}" required>
  <label for="end_date">Al:</label>
  <input type="date" name="end_date" value="{{ end_date }}" required>
  <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded">Analizza</button>

  <div class="flex flex-wrap gap-2 ml-4">
    <a href="{{ url_for('analisi_pesature', start_date=(oggi - timedelta(days=7)).isoformat(), end_date=oggi.isoformat()) }}"
       class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Ultima Settimana</a>
    <a href="{{ url_for('analisi_pesature', start_date=(oggi - timedelta(days=14)).isoformat(), end_date=oggi.isoformat()) }}"
       class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Ultime 2 Settimane</a>
    <a href="{{ url_for('analisi_pesature', start_date=(oggi - timedelta(days=30)).isoformat(), end_date=oggi.isoformat()) }}"
       class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Mensile</a>
    <a href="{{ url_for('analisi_pesature', start_date='2000-01-01', end_date=oggi.isoformat()) }}"
       class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">Totale</a>
  </div>
</form>

{% if labels %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <h3 class="text-lg font-semibold mb-1">Peso</h3>
      <canvas id="pesoChart"></canvas>
    </div>
    <div>
      <h3 class="text-lg font-semibold mb-1">BMI</h3>
      <canvas id="bmiChart"></canvas>
    </div>
    <div>
      <h3 class="text-lg font-semibold mb-1">Grasso Corporeo (%)</h3>
      <canvas id="grassoChart"></canvas>
    </div>
    <div>
      <h3 class="text-lg font-semibold mb-1">Grasso Sottocutaneo (%)</h3>
      <canvas id="grassoSottoChart"></canvas>
    </div>
  </div>

  <script>
    const labels = {{ labels | tojson }};
    const grafico = (id, label, data, color) => {
      new Chart(document.getElementById(id).getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            borderColor: color,
            tension: 0.3,
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } }
        }
      });
    };

    grafico('pesoChart', 'Peso (kg)', {{ pesate_data["peso"] | tojson }}, 'rgba(54, 162, 235, 1)');
    grafico('bmiChart', 'BMI', {{ pesate_data["bmi"] | tojson }}, 'rgba(153, 102, 255, 1)');
    grafico('grassoChart', 'Grasso Corporeo (%)', {{ pesate_data["grasso_corporeo"] | tojson }}, 'rgba(255, 99, 132, 1)');
    grafico('grassoSottoChart', 'Grasso Sottocutaneo (%)', {{ pesate_data["grasso_sottocutaneo"] | tojson }}, 'rgba(255, 159, 64, 1)');
  </script>

  <div class="mt-6 bg-white shadow p-4 rounded">
    <h3 class="text-xl font-semibold mb-2">Commento Composizione Corporea</h3>
    <p>{{ commento.replace('\n', '<br>')|safe }}</p>
  </div>
{% endif %}
{% endblock %}
